import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, Minus, Users, User, Calculator, RefreshCcw, Trophy, 
  DollarSign, Settings, Trash2, Sun, Moon, CheckCircle2, 
  AlertCircle, X, ChevronRight, UserPlus, Zap, Target, Undo2
} from 'lucide-react';

// External script for Confetti
const loadConfetti = () => {
  return new Promise((resolve) => {
    if (window.confetti) {
      resolve(window.confetti);
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';
    script.onload = () => resolve(window.confetti);
    document.head.appendChild(script);
  });
};

const App = () => {
  // --- STATE ---
  const [theme, setTheme] = useState('light'); 
  const [activeView, setActiveView] = useState('score'); 
  const [gameMode, setGameMode] = useState('1vs1'); 
  
  const [raceTo, setRaceTo] = useState(7);
  const [unitPrice, setUnitPrice] = useState(10000); 
  const [tableBill, setTableBill] = useState(0);
  const [splitMode, setSplitMode] = useState('73'); 
  const [winner, setWinner] = useState(null);

  // Players state
  const [players1vs1, setPlayers1vs1] = useState([
    { id: 1, name: 'PLAYER 01', score: 0, personal: 0 },
    { id: 2, name: 'PLAYER 02', score: 0, personal: 0 },
  ]);

  const [playersDen, setPlayersDen] = useState([
    { id: 1, name: 'PLAYER A', score: 0, personal: 0 },
    { id: 2, name: 'PLAYER B', score: 0, personal: 0 },
    { id: 3, name: 'PLAYER C', score: 0, personal: 0 },
  ]);

  // Recall (Backup) state
  const [lastSession, setLastSession] = useState(null);

  // --- HELPERS ---
  const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');

  const handleConfetti = async () => {
    const confetti = await loadConfetti();
    confetti({
      particleCount: 150,
      spread: 70,
      origin: { y: 0.6 },
      colors: theme === 'dark' ? ['#d946ef', '#06b6d4', '#8b5cf6'] : ['#a21caf', '#0891b2', '#6d28d9']
    });
  };

  const updateScore = (mode, id, delta) => {
    if (winner) return;
    
    if (mode === '1vs1') {
      const newPlayers = players1vs1.map(p => {
        if (p.id === id) {
          const newScore = Math.max(0, p.score + delta);
          if (newScore === raceTo && raceTo > 0) {
            setWinner(p.name);
            handleConfetti();
          }
          return { ...p, score: newScore };
        }
        return p;
      });
      setPlayers1vs1(newPlayers);
    } else {
      setPlayersDen(playersDen.map(p => p.id === id ? { ...p, score: p.score + delta } : p));
    }
  };

  const editName = (mode, id, newName) => {
    if (mode === '1vs1') {
      setPlayers1vs1(players1vs1.map(p => {
        if (p.id === id) {
          return { ...p, name: newName };
        }
        return p;
      }));
    } else {
      setPlayersDen(playersDen.map(p => {
        if (p.id === id) {
          return { ...p, name: newName };
        }
        return p;
      }));
    }
  };

  const addPlayerDen = () => {
    const newId = Date.now();
    setPlayersDen([...playersDen, { id: newId, name: `PLAYER ${String.fromCharCode(65 + playersDen.length)}`, score: 0, personal: 0 }]);
  };

  const removePlayerDen = (id) => {
    if (playersDen.length > 2) {
      setPlayersDen(playersDen.filter(p => p.id !== id));
    }
  };

  const resetAllData = () => {
    // Backup current session before wiping
    setLastSession({
      raceTo,
      unitPrice,
      tableBill,
      splitMode,
      players1vs1,
      playersDen,
      gameMode
    });

    // Wipe all
    setWinner(null);
    setRaceTo(7);
    setUnitPrice(10000);
    setTableBill(0);
    
    // Reset players and names
    setPlayers1vs1([
      { id: 1, name: 'PLAYER 01', score: 0, personal: 0 },
      { id: 2, name: 'PLAYER 02', score: 0, personal: 0 },
    ]);
    
    setPlayersDen([
      { id: 1, name: 'PLAYER A', score: 0, personal: 0 },
      { id: 2, name: 'PLAYER B', score: 0, personal: 0 },
      { id: 3, name: 'PLAYER C', score: 0, personal: 0 },
    ]);
  };

  const recallData = () => {
    if (!lastSession) return;
    setRaceTo(lastSession.raceTo);
    setUnitPrice(lastSession.unitPrice);
    setTableBill(lastSession.tableBill);
    setSplitMode(lastSession.splitMode);
    setPlayers1vs1(lastSession.players1vs1);
    setPlayersDen(lastSession.playersDen);
    setGameMode(lastSession.gameMode);
    setLastSession(null);
  };

  // --- CALCULATIONS ---
  const denSum = useMemo(() => playersDen.reduce((acc, p) => acc + p.score, 0), [playersDen]);
  const isDenValid = denSum === 0;

  const billingData = useMemo(() => {
    const players = gameMode === '1vs1' ? players1vs1 : playersDen;
    const n = players.length;

    if (gameMode === '1vs1') {
      const [p1, p2] = players;
      let p1Table, p2Table;
      if (splitMode === 'equal' || p1.score === p2.score) {
        p1Table = p2Table = tableBill / 2;
      } else {
        const p1Win = p1.score > p2.score;
        p1Table = p1Win ? tableBill * 0.3 : tableBill * 0.7;
        p2Table = !p1Win ? tableBill * 0.3 : tableBill * 0.7;
      }
      return [
        { ...p1, tableShare: p1Table, total: p1Table + p1.personal },
        { ...p2, tableShare: p2Table, total: p2Table + p2.personal }
      ];
    } else {
      const tableShareEach = tableBill / n;
      return players.map(p => ({
        ...p,
        tableShare: tableShareEach,
        gameExchange: -(p.score * unitPrice),
        total: tableShareEach - (p.score * unitPrice) + p.personal
      }));
    }
  }, [gameMode, players1vs1, playersDen, tableBill, splitMode, unitPrice]);

  // --- UI THEME COLORS ---
  const accentBg = 'bg-fuchsia-600';
  const accentText = 'text-fuchsia-500';

  const themeClasses = theme === 'dark' 
    ? 'bg-[#0a0510] text-slate-100' 
    : 'bg-slate-50 text-slate-900';
  
  const glassPanel = theme === 'dark'
    ? 'bg-white/[0.03] backdrop-blur-3xl border border-white/10 shadow-[0_8px_32px_rgba(0,0,0,0.6)]'
    : 'bg-white/70 backdrop-blur-3xl border border-slate-200 shadow-[0_8px_32px_rgba(0,0,0,0.05)]';

  const subPanel = theme === 'dark'
    ? 'bg-black/40 border border-white/5'
    : 'bg-white border border-slate-200';

  // Multiplayer color palettes
  const playerColors = [
    { name: 'Blue', card: theme === 'dark' ? 'bg-blue-900/20' : 'bg-blue-50', bar: 'bg-blue-500', btn: 'bg-blue-600' },
    { name: 'Red', card: theme === 'dark' ? 'bg-red-900/20' : 'bg-red-50', bar: 'bg-red-500', btn: 'bg-red-600' },
    { name: 'Emerald', card: theme === 'dark' ? 'bg-emerald-900/20' : 'bg-emerald-50', bar: 'bg-emerald-500', btn: 'bg-emerald-600' },
    { name: 'Amber', card: theme === 'dark' ? 'bg-amber-900/20' : 'bg-amber-50', bar: 'bg-amber-500', btn: 'bg-amber-600' },
    { name: 'Fuchsia', card: theme === 'dark' ? 'bg-fuchsia-900/20' : 'bg-fuchsia-50', bar: 'bg-fuchsia-500', btn: 'bg-fuchsia-600' },
    { name: 'Indigo', card: theme === 'dark' ? 'bg-indigo-900/20' : 'bg-indigo-50', bar: 'bg-indigo-500', btn: 'bg-indigo-600' },
    { name: 'Orange', card: theme === 'dark' ? 'bg-orange-900/20' : 'bg-orange-50', bar: 'bg-orange-500', btn: 'bg-orange-600' },
    { name: 'Teal', card: theme === 'dark' ? 'bg-teal-900/20' : 'bg-teal-50', bar: 'bg-teal-500', btn: 'bg-teal-600' },
  ];

  return (
    <div className={`h-screen flex flex-col transition-colors duration-500 ${themeClasses} overflow-hidden font-sans`}>
      
      {/* HEADER */}
      <header className={`px-6 py-4 flex justify-between items-center ${glassPanel} z-50`}>
        <div className="flex items-center gap-3">
          <div className={`${accentBg} w-10 h-10 rounded-2xl flex items-center justify-center shadow-[0_0_20px_rgba(217,70,239,0.4)] rotate-3`}>
            <Target className="text-white" size={20} />
          </div>
          <div>
            <h1 className="text-lg font-black tracking-tighter leading-none bg-gradient-to-r from-fuchsia-500 to-cyan-400 bg-clip-text text-transparent">
              PST TOOL
            </h1>
            <span className="text-[9px] font-black tracking-[0.25em] opacity-40 uppercase">Pool Scoring Tool</span>
          </div>
        </div>
        <div className="flex gap-2">
          {lastSession && (
            <button 
              onClick={recallData} 
              title="Recall (Undo Reset)"
              className="p-2.5 rounded-2xl transition-all active:scale-90 text-cyan-500 bg-cyan-500/10 border border-cyan-500/20 animate-pulse"
            >
              <Undo2 size={18} />
            </button>
          )}
          <button onClick={toggleTheme} className={`p-2.5 rounded-2xl transition-all active:scale-90 ${subPanel}`}>
            {theme === 'dark' ? <Sun size={18} className="text-amber-400" /> : <Moon size={18} className="text-indigo-600" />}
          </button>
          <button onClick={resetAllData} title="Reset All (Clear Names & Scores)" className={`p-2.5 rounded-2xl transition-all active:scale-90 ${accentText} ${subPanel}`}>
            <RefreshCcw size={18} />
          </button>
        </div>
      </header>

      {/* NAVIGATION TABS */}
      <div className="px-6 py-2 flex gap-3">
        <button 
          onClick={() => setActiveView('score')}
          className={`flex-1 py-3 px-4 rounded-2xl font-black text-[10px] tracking-widest flex items-center justify-center gap-2 transition-all duration-300 ${activeView === 'score' ? accentBg + ' text-white shadow-lg' : subPanel + ' opacity-40'}`}
        >
          <Trophy size={16} /> SCORE
        </button>
        <button 
          onClick={() => setActiveView('bill')}
          className={`flex-1 py-3 px-4 rounded-2xl font-black text-[10px] tracking-widest flex items-center justify-center gap-2 transition-all duration-300 ${activeView === 'bill' ? 'bg-cyan-600 text-white shadow-lg' : subPanel + ' opacity-40'}`}
        >
          <Calculator size={16} /> BILL
        </button>
      </div>

      <main className="flex-1 flex flex-col overflow-hidden px-6 py-4">
        
        {winner && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-2xl p-6">
            <div className={`w-full max-w-sm p-12 rounded-[3.5rem] text-center border-2 border-fuchsia-500/30 shadow-[0_0_60px_rgba(217,70,239,0.25)] animate-in zoom-in duration-300 ${glassPanel}`}>
              <div className={`${accentBg} w-24 h-24 rounded-[2rem] mx-auto flex items-center justify-center mb-8 shadow-2xl shadow-fuchsia-500/50 rotate-6`}>
                <Trophy size={48} className="text-white" />
              </div>
              <h2 className="text-4xl font-black mb-2 italic tracking-tighter uppercase text-white">VICTORY!</h2>
              <p className="text-2xl text-fuchsia-400 font-bold uppercase mb-10 tracking-wider drop-shadow-lg">{winner}</p>
              <button 
                onClick={() => setWinner(null)}
                className="w-full py-5 bg-gradient-to-r from-fuchsia-600 to-indigo-600 text-white font-black rounded-3xl shadow-xl active:scale-95 transition"
              >
                RETURN TO LOBBY
              </button>
            </div>
          </div>
        )}

        {/* VIEW: SCOREBOARD */}
        {activeView === 'score' && (
          <div className="h-full flex flex-col space-y-4">
            {/* RACE TO - PROMINENT & CENTERED */}
            <div className={`p-4 rounded-[2rem] relative overflow-hidden flex flex-col items-center justify-center ${glassPanel}`}>
               <div className="flex flex-col items-center gap-3 w-full">
                  <div className={`flex p-1 rounded-2xl w-32 ${subPanel}`}>
                    <button onClick={() => setGameMode('1vs1')} className={`flex-1 py-2 rounded-xl transition-all duration-300 flex justify-center ${gameMode === '1vs1' ? accentBg + ' text-white shadow-lg' : 'opacity-40 hover:opacity-100'}`}>
                      <User size={18} />
                    </button>
                    <button onClick={() => setGameMode('den')} className={`flex-1 py-2 rounded-xl transition-all duration-300 flex justify-center ${gameMode === 'den' ? accentBg + ' text-white shadow-lg' : 'opacity-40 hover:opacity-100'}`}>
                      <Users size={18} />
                    </button>
                  </div>

                  {gameMode === '1vs1' ? (
                    <div className="flex flex-col items-center gap-1 animate-in zoom-in duration-500">
                      <span className="text-[10px] font-black uppercase tracking-[0.4em] opacity-40">Race To Target</span>
                      <div className="flex items-center gap-10">
                        <button onClick={() => setRaceTo(Math.max(1, raceTo - 1))} className={`w-10 h-10 rounded-2xl flex items-center justify-center transition-all active:scale-90 ${subPanel} border-fuchsia-500/20`}><Minus size={22} className="text-fuchsia-500" /></button>
                        <span className={`text-7xl font-black tabular-nums tracking-tighter ${accentText} drop-shadow-[0_0_15px_rgba(217,70,239,0.3)]`}>{raceTo}</span>
                        <button onClick={() => setRaceTo(raceTo + 1)} className={`w-10 h-10 rounded-2xl flex items-center justify-center transition-all active:scale-90 ${subPanel} border-fuchsia-500/20`}><Plus size={22} className="text-fuchsia-500" /></button>
                      </div>
                    </div>
                  ) : (
                    <div className="flex flex-col items-center gap-2 animate-in fade-in duration-500">
                      <div className="flex items-center gap-4">
                        <span className={`text-xs font-black uppercase tracking-widest ${isDenValid ? 'text-green-500' : 'text-red-500'}`}>
                          {isDenValid ? 'Balance Verified' : `Discrepancy: ${denSum}`}
                        </span>
                        <button onClick={addPlayerDen} className="w-10 h-10 rounded-2xl bg-cyan-600 text-white flex items-center justify-center shadow-lg active:scale-95 transition-all"><UserPlus size={20} /></button>
                      </div>
                    </div>
                  )}
               </div>
            </div>

            {/* PLAYER SCORING CARDS - SCALING VERTICALLY */}
            {gameMode === '1vs1' ? (
              <div className="flex-1 grid grid-cols-2 gap-4 pb-4 overflow-hidden">
                {players1vs1.map((p, idx) => {
                  const colorConfig = playerColors[idx % playerColors.length];
                  return (
                    <div key={p.id} className={`flex flex-col h-full p-4 rounded-[3rem] relative overflow-hidden transition-all duration-500 border border-slate-200/50 shadow-sm ${colorConfig.card}`}>
                      <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${colorConfig.bar}`}></div>
                      
                      <div className="flex flex-col h-full justify-between items-center py-4">
                        <input 
                          type="text" value={p.name} onChange={(e) => editName('1vs1', p.id, e.target.value)}
                          className="text-center bg-transparent text-2xl md:text-4xl font-black uppercase tracking-tighter opacity-80 focus:opacity-100 focus:outline-none w-full truncate px-2"
                          placeholder="NAME"
                        />
                        
                        <div className="flex-1 w-full flex flex-col justify-center items-center relative px-2">
                          <button 
                            onClick={() => updateScore('1vs1', p.id, -1)} 
                            className="absolute left-0 w-12 h-12 rounded-xl flex items-center justify-center bg-white/60 text-red-500 shadow-sm border border-slate-200/30 active:scale-90 z-10"
                          >
                            <Minus size={24} strokeWidth={3} />
                          </button>

                          <span className="text-8xl md:text-[12rem] font-black tabular-nums tracking-tighter drop-shadow-xl text-center flex items-center leading-none">
                            {p.score}
                          </span>

                          <button 
                            onClick={() => updateScore('1vs1', p.id, 1)} 
                            className={`absolute right-0 w-12 h-12 rounded-xl flex items-center justify-center shadow-lg ${colorConfig.btn} text-white active:scale-90 z-10`}
                          >
                            <Plus size={24} strokeWidth={3} />
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              /* TEAM MATCH SCORING - NOW SCALING VERTICALLY WITH INDIVIDUAL COLORS */
              <div className="flex-1 flex flex-col gap-3 pb-6 overflow-hidden">
                {playersDen.map((p, idx) => {
                  const colorConfig = playerColors[idx % playerColors.length];
                  return (
                    <div key={p.id} className={`flex-1 p-4 rounded-[2.5rem] relative overflow-hidden transition-all duration-500 border border-slate-200/50 flex items-center justify-between ${colorConfig.card}`}>
                      <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${colorConfig.bar}`}></div>
                      
                      <button 
                        onClick={() => updateScore('den', p.id, -1)} 
                        className="w-12 h-12 rounded-xl flex items-center justify-center bg-white/60 text-red-500 shadow-sm border border-slate-200/30 active:scale-90 z-10"
                      >
                        <Minus size={20} strokeWidth={3} />
                      </button>

                      <div className="flex-1 flex flex-col items-center justify-center mx-4 overflow-hidden">
                        <input 
                          type="text" value={p.name} onChange={(e) => editName('den', p.id, e.target.value)} 
                          className="w-full bg-transparent text-center font-black uppercase text-xl md:text-2xl opacity-80 focus:opacity-100 focus:outline-none truncate px-2" 
                          placeholder="NAME"
                        />
                        <span className={`text-6xl md:text-7xl font-black tabular-nums transition-all leading-tight ${p.score < 0 ? 'text-red-500' : p.score > 0 ? colorConfig.bar.replace('bg-', 'text-') : 'opacity-20'}`}>
                          {p.score}
                        </span>
                      </div>

                      <div className="flex items-center gap-2">
                        <button onClick={() => removePlayerDen(p.id)} className="p-2 text-slate-400 hover:text-red-500"><Trash2 size={16} /></button>
                        <button 
                          onClick={() => updateScore('den', p.id, 1)} 
                          className={`w-12 h-12 rounded-xl flex items-center justify-center shadow-md ${colorConfig.btn} text-white active:scale-90 z-10`}
                        >
                          <Plus size={20} strokeWidth={3} />
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* VIEW: SETTLEMENT */}
        {activeView === 'bill' && (
          <div className="flex-1 overflow-y-auto space-y-6 animate-in slide-in-from-right-8 duration-500 pb-10">
            <section className={`rounded-[2.5rem] overflow-hidden ${glassPanel}`}>
              <div className="p-8 space-y-6 border-b border-white/5">
                <div className="flex items-center gap-4 mb-2">
                  <Calculator className="text-cyan-600" size={24} />
                  <h3 className="text-xl font-black italic tracking-tighter uppercase text-slate-700">SETTLEMENT</h3>
                </div>

                <div className="space-y-5">
                  <div className="group">
                    <label className="text-[10px] font-black uppercase tracking-[0.2em] opacity-40 mb-2 block ml-1">Hourly Fee (x1,000 VND)</label>
                    <div className="relative">
                      <span className="absolute left-5 top-1/2 -translate-y-1/2 opacity-30 text-cyan-600 font-black text-xl">k</span>
                      <input 
                        type="number" 
                        min="0"
                        value={tableBill / 1000 || ''} 
                        onChange={(e) => setTableBill((parseInt(e.target.value) || 0) * 1000)}
                        className={`w-full py-4 pl-12 pr-16 rounded-2xl font-black text-xl focus:outline-none transition-all group-focus-within:ring-2 ring-cyan-500/30 ${subPanel}`} 
                        placeholder="e.g. 40"
                      />
                      <span className="absolute right-6 top-1/2 -translate-y-1/2 opacity-20 font-black text-[10px] uppercase tracking-widest">.000đ</span>
                    </div>
                  </div>

                  {gameMode === 'den' ? (
                    <div>
                      <label className="text-[10px] font-black uppercase tracking-[0.2em] opacity-40 mb-2 block ml-1">Value Per Point (x1,000 VND)</label>
                      <div className="relative">
                        <span className="absolute left-5 top-1/2 -translate-y-1/2 opacity-30 text-cyan-600 font-black text-xl">k</span>
                        <input 
                          type="number" 
                          min="0"
                          value={unitPrice / 1000 || ''} 
                          onChange={(e) => setUnitPrice((parseInt(e.target.value) || 0) * 1000)}
                          className={`w-full py-4 pl-12 pr-16 rounded-2xl font-black text-xl focus:outline-none ${subPanel}`}
                        />
                      </div>
                    </div>
                  ) : (
                    <div>
                      <label className="text-[10px] font-black uppercase tracking-[0.2em] opacity-40 mb-2 block ml-1">Division Policy</label>
                      <select 
                        value={splitMode} onChange={(e) => setSplitMode(e.target.value)}
                        className={`w-full py-4 px-6 rounded-2xl font-black text-lg focus:outline-none border-0 appearance-none bg-right pr-12 ${subPanel}`}
                      >
                        <option value="73">70/30 (W:30/L:70)</option>
                        <option value="equal">50/50 (Fair Share)</option>
                      </select>
                    </div>
                  )}

                  <div className="pt-2">
                    <label className="text-[10px] font-black uppercase tracking-[0.2em] opacity-40 mb-4 block ml-1 text-slate-600">Individual Expenses (x1,000 VND)</label>
                    <div className="space-y-2">
                      {(gameMode === '1vs1' ? players1vs1 : playersDen).map(p => (
                        <div key={p.id} className={`flex items-center gap-4 p-3 rounded-xl ${subPanel} hover:border-slate-300 transition-all`}>
                          <span className="text-[9px] font-black uppercase truncate flex-1 opacity-50 tracking-widest">{p.name}</span>
                          <div className="relative w-28">
                            <input 
                              type="number" 
                              min="0"
                              value={p.personal / 1000 || ''}
                              placeholder="0" 
                              className="w-full bg-transparent text-right pr-4 font-black text-cyan-600 focus:outline-none text-lg"
                              onChange={(e) => {
                                const val = (parseInt(e.target.value) || 0) * 1000;
                                if(gameMode === '1vs1') setPlayers1vs1(players1vs1.map(x => x.id === p.id ? {...x, personal: val} : x));
                                else setPlayersDen(playersDen.map(x => x.id === p.id ? {...x, personal: val} : x));
                              }}
                            />
                            <span className="absolute right-0 top-1/2 -translate-y-1/2 opacity-20 font-black text-[9px]">k</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              {/* FINAL RESULTS LIST */}
              <div className="p-8 space-y-4 bg-slate-900/5">
                {billingData.map((p, idx) => {
                  const colorConfig = playerColors[idx % playerColors.length];
                  return (
                    <div key={p.id} className={`p-5 rounded-[1.5rem] flex flex-col gap-3 border border-slate-200/50 ${theme === 'dark' ? 'bg-white/[0.02]' : 'bg-white/80 shadow-sm'}`}>
                      <div className="flex justify-between items-center">
                        <span className="text-[10px] font-black uppercase tracking-[0.2em] opacity-40">{p.name}</span>
                        <span className={`text-xl font-black ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>{p.total.toLocaleString()}đ</span>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="px-2 py-1 bg-slate-200/50 rounded-lg text-[8px] font-bold uppercase opacity-60 tracking-wider">Table: {Math.round(p.tableShare).toLocaleString()}đ</div>
                        {p.personal > 0 && <div className="px-2 py-1 bg-cyan-500/10 text-cyan-600 rounded-lg text-[8px] font-bold uppercase tracking-wider">Extras: {p.personal.toLocaleString()}đ</div>}
                        {p.gameExchange !== undefined && p.gameExchange !== 0 && (
                          <div className={`px-2 py-1 rounded-lg text-[8px] font-bold uppercase tracking-wider ${p.gameExchange > 0 ? 'bg-red-500/10 text-red-500' : 'bg-fuchsia-500/10 text-fuchsia-600'}`}>
                            {p.gameExchange > 0 ? `Loss: +${p.gameExchange.toLocaleString()}` : `Gain: ${p.gameExchange.toLocaleString()}`}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}

                {/* Total Due Field - Updated to Emerald/Green */}
                <div className={`bg-gradient-to-br from-emerald-500 to-emerald-800 mt-6 p-6 rounded-[2rem] flex items-center justify-between text-white shadow-xl shadow-emerald-500/20 border border-emerald-400/20`}>
                  <div className="flex flex-col">
                    <span className="text-[8px] font-black uppercase tracking-[0.3em] opacity-70 mb-1">Total Due</span>
                    <span className="text-3xl font-black italic tracking-tighter tabular-nums">{Math.round(billingData.reduce((acc, p) => acc + p.total, 0)).toLocaleString()}đ</span>
                  </div>
                  <div className="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-md">
                    <CheckCircle2 size={24} />
                  </div>
                </div>
              </div>
            </section>
          </div>
        )}
      </main>
    </div>
  );
};

export default App;